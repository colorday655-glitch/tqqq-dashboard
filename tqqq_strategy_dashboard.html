<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQQQ 量化决策终端 - Polygon 实战版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap');

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #020617;
            color: #ffffff;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 50;
        }

        #chart-container {
            flex-grow: 1;
            width: 100%;
            position: relative;
        }

        .status-pill {
            padding: 2px 10px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .floating-panel {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .btn-glow:hover {
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }

        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- 顶栏：显示实时价格与连接状态 -->
<header class="glass-panel px-6 py-3 flex justify-between items-center">
    <div class="flex items-center space-x-4">
        <div class="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-500/30">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
        </div>
        <div>
            <h1 class="text-lg font-black tracking-tighter uppercase leading-none italic">TQQQ <span class="text-indigo-400">Quant</span></h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">决策引擎 v5.5 // Polygon.io 实时驱动</p>
        </div>
    </div>

    <div class="flex items-center space-x-10">
        <div class="flex flex-col items-end">
            <span class="text-slate-500 uppercase text-[9px] font-bold tracking-widest">实时价格 (USD)</span>
            <div class="flex items-baseline space-x-2">
                <span id="price-display" class="text-2xl mono font-bold tracking-tighter">--.--</span>
                <span id="pct-display" class="text-xs font-bold">--%</span>
            </div>
        </div>
        <div class="flex flex-col items-start border-l border-slate-800 pl-8">
            <span class="text-slate-500 uppercase text-[9px] font-bold tracking-widest">系统连接状态</span>
            <div id="api-status" class="status-pill bg-slate-800 text-slate-400 mt-1 flex items-center">
                <span class="w-1.5 h-1.5 rounded-full bg-slate-500 mr-2"></span>
                模拟演示模式
            </div>
        </div>
    </div>
</header>

<main id="chart-container">
    <!-- API 配置悬浮面板 -->
    <div class="absolute top-6 right-6 z-[60] floating-panel p-4 rounded-2xl w-72">
        <div class="flex flex-col space-y-4">
            <div class="flex flex-col">
                <label class="text-[9px] font-black text-slate-500 uppercase mb-1.5">Polygon.io API Key</label>
                <div class="flex space-x-2">
                    <input type="password" id="api-key" placeholder="粘贴 API Key" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-indigo-500 flex-1 transition-all">
                    <button onclick="connectPolygon()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-[10px] font-black transition-all btn-glow uppercase tracking-tighter">同步</button>
                </div>
            </div>
            <div id="log-msg" class="text-[9px] text-slate-400 italic">尚未连接实盘数据</div>
        </div>
    </div>

    <!-- 决策核心面板 -->
    <div class="absolute bottom-8 left-8 z-[60] flex space-x-4 pointer-events-none">
        <!-- 指标得分 -->
        <div class="floating-panel p-6 rounded-3xl w-80">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-xs font-black text-indigo-400 uppercase tracking-widest">量化多因子分析</h3>
                <span class="text-[9px] bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded border border-indigo-500/20 font-bold uppercase">1分钟 K线</span>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-400">RSI (14) 动能</span>
                    <span id="stat-rsi" class="mono font-bold text-indigo-300">--</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-400">布林带 (BB) 偏移度</span>
                    <span id="stat-bb" class="mono font-bold">--</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-400">EMA 200 趋势背景</span>
                    <span id="stat-trend" class="mono font-bold">--</span>
                </div>
                <div class="pt-5 border-t border-white/5 mt-2">
                    <div id="master-decision" class="text-center py-4 rounded-2xl bg-slate-800 text-slate-500 text-sm font-black uppercase tracking-widest transition-all duration-500">
                        计算引擎待命
                    </div>
                </div>
            </div>
        </div>

        <!-- 决策历史日志 -->
        <div class="floating-panel p-4 rounded-3xl w-64 hidden xl:block">
            <div class="flex items-center justify-between mb-3 border-b border-white/5 pb-2">
                <h3 class="text-[10px] font-black text-slate-500 uppercase">决策指令历史</h3>
                <span class="text-[8px] text-slate-600 uppercase">实时自动更新</span>
            </div>
            <div id="decision-log" class="space-y-2.5 max-h-56 overflow-y-auto pr-2">
                <div class="text-[9px] text-slate-600 italic">等待 5 分钟决策点...</div>
            </div>
        </div>
    </div>
</main>

<script>
    // --- 量化指标计算工具类 ---
    const Indicators = {
        ema(data, period) {
            if (data.length < period) return [];
            const k = 2 / (period + 1);
            let emaValue = data[0].close;
            return data.map(val => {
                emaValue = (val.close * k) + (emaValue * (1 - k));
                return { time: val.time, value: emaValue };
            });
        },
        bollinger(data, period = 20, stdDev = 2) {
            let upper = [], lower = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    upper.push({time: data[i].time, value: NaN});
                    lower.push({time: data[i].time, value: NaN});
                    continue;
                }
                const slice = data.slice(i - period + 1, i + 1).map(d => d.close);
                const avg = slice.reduce((a, b) => a + b, 0) / period;
                const sd = Math.sqrt(slice.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b, 0) / period);
                upper.push({ time: data[i].time, value: avg + stdDev * sd });
                lower.push({ time: data[i].time, value: avg - stdDev * sd });
            }
            return { upper, lower };
        },
        rsi(data, period = 14) {
            if (data.length < 2) return Array(data.length).fill(50);
            let results = [];
            let gains = 0, losses = 0;
            for (let i = 1; i < data.length; i++) {
                let diff = data[i].close - data[i - 1].close;
                gains += diff > 0 ? diff : 0;
                losses += diff < 0 ? -diff : 0;
                if (i >= period) {
                    const rs = (gains / period) / (losses / period || 1);
                    results.push(100 - (100 / (1 + rs)));
                    // 简化平滑
                    let prevDiff = data[i - period + 1].close - data[i - period].close;
                    gains -= (prevDiff > 0 ? prevDiff : 0);
                    losses -= (prevDiff < 0 ? -prevDiff : 0);
                } else results.push(50);
            }
            return results;
        }
    };

    // --- 图表变量 ---
    let chart, candleSeries, bbUpper, bbLower, ema200;
    let candleData = [];
    let markers = [];
    let isRealData = false;

    // --- 初始化图表配置 ---
    function initChart() {
        const container = document.getElementById('chart-container');
        chart = LightweightCharts.createChart(container, {
            layout: { background: { color: '#020617' }, textColor: '#64748b', fontSize: 11 },
            grid: { vertLines: { color: 'rgba(255,255,255,0.02)' }, horzLines: { color: 'rgba(255,255,255,0.02)' } },
            timeScale: { borderColor: 'rgba(255,255,255,0.1)', timeVisible: true },
            rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)', autoScale: true },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
        });

        candleSeries = chart.addCandlestickSeries({
            upColor: '#22c55e', downColor: '#ef4444', borderVisible: false,
            wickUpColor: '#22c55e', wickDownColor: '#ef4444'
        });

        // 添加技术指标图层
        bbUpper = chart.addLineSeries({ color: 'rgba(99, 102, 241, 0.2)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
        bbLower = chart.addLineSeries({ color: 'rgba(99, 102, 241, 0.2)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
        ema200 = chart.addLineSeries({ color: 'rgba(168, 85, 247, 0.4)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });

        window.addEventListener('resize', () => chart.resize(container.clientWidth, container.clientHeight));
    }

    // --- 核心量化打标策略 ---
    function runQuantitativeAnalysis() {
        if (candleData.length < 50) return;

        const rsis = Indicators.rsi(candleData);
        const bb = Indicators.bollinger(candleData);
        const e200 = Indicators.ema(candleData, 200);

        ema200.setData(e200);
        bbUpper.setData(bb.upper.filter(d => !isNaN(d.value)));
        bbLower.setData(bb.lower.filter(d => !isNaN(d.value)));

        markers = [];
        const logContainer = document.getElementById('decision-log');
        logContainer.innerHTML = '';

        candleData.forEach((candle, i) => {
            const date = new Date(candle.time * 1000);
            // 决策逻辑：每 5 分钟评估一次
            if (date.getMinutes() % 5 === 0 && i > 30) {
                const rsi = rsis[i] || 50;
                const bbl = bb.lower[i]?.value;
                const bbu = bb.upper[i]?.value;
                const trend = e200[i]?.value;

                let action = "持仓不动";
                let color = "#64748b";
                let shape = "circle";
                let pos = "aboveBar";

                // 1. 买入判定：RSI 低于 36 + 触及布林下轨 + 均线趋势稳健
                if (rsi < 36 && candle.low <= bbl && candle.close > (trend * 0.98)) {
                    action = "买入建议";
                    color = "#22c55e";
                    shape = "arrowUp";
                    pos = "belowBar";
                }
                // 2. 卖出判定：RSI 高于 64 + 触及布林上轨
                else if (rsi > 64 && candle.high >= bbu) {
                    action = "止盈建议";
                    color = "#ef4444";
                    shape = "arrowDown";
                    pos = "aboveBar";
                }

                markers.push({
                    time: candle.time, position: pos, color: color,
                    shape: shape, text: action, size: 1
                });

                // 实时写入面板日志
                const logEntry = document.createElement('div');
                logEntry.className = `flex justify-between items-center text-[9px] font-bold border-b border-white/5 pb-1 ${action.includes('买入') ? 'text-green-400' : action.includes('止盈') ? 'text-red-400' : 'text-slate-500'}`;
                const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                logEntry.innerHTML = `<span>[${timeStr}]</span> <span>${action}</span>`;
                logContainer.prepend(logEntry);
            }
        });

        candleSeries.setMarkers(markers);

        // 更新实时状态数值
        const lastRsi = rsis[rsis.length-1] || 50;
        const currentPrice = candleData[candleData.length-1].close;
        document.getElementById('stat-rsi').innerText = lastRsi.toFixed(1);
        document.getElementById('stat-trend').innerText = currentPrice > e200[e200.length-1]?.value ? "牛市趋势" : "趋势偏弱";
        document.getElementById('stat-bb').innerText = currentPrice < bb.lower[bb.lower.length-1]?.value ? "触底偏离" : "区间波动";

        const hud = document.getElementById('master-decision');
        const lastMarker = markers[markers.length-1];
        if (lastMarker) {
            hud.innerText = `最新指令: ${lastMarker.text}`;
            hud.className = `text-center py-4 rounded-2xl text-sm font-black uppercase tracking-widest ${lastMarker.text.includes('买入') ? 'bg-green-500/20 text-green-400 shadow-[0_0_20px_rgba(34,197,94,0.15)]' : lastMarker.text.includes('止盈') ? 'bg-red-500/20 text-red-400 shadow-[0_0_20px_rgba(239,68,68,0.15)]' : 'bg-slate-800 text-slate-400'}`;
        }
    }

    // --- Polygon.io API 同步功能 ---
    async function connectPolygon() {
        const key = document.getElementById('api-key').value;
        if (!key) return;

        const log = document.getElementById('log-msg');
        log.innerHTML = `<div class="flex items-center space-x-2"><div class="loader"></div><span>正在接入 Polygon.io 实时数据源...</span></div>`;

        try {
            const now = new Date();
            const end = now.toISOString().split('T')[0];
            const start = new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // 请求 1 分钟精度 K 线
            const url = `https://api.polygon.io/v2/aggs/ticker/TQQQ/range/1/minute/${start}/${end}?adjusted=true&sort=asc&limit=1000&apiKey=${key}`;
            const response = await fetch(url);
            const result = await response.json();

            if (result.results && result.results.length > 0) {
                candleData = result.results.map(r => ({
                    time: r.t / 1000,
                    open: r.o, high: r.h, low: r.l, close: r.c
                }));

                candleSeries.setData(candleData);
                runQuantitativeAnalysis();

                isRealData = true;
                log.innerText = "Polygon 数据连接成功";
                const status = document.getElementById('api-status');
                status.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-2 animate-pulse"></span>实时监控中`;
                status.className = "status-pill bg-green-500/10 text-green-400 mt-1 flex items-center";
            } else {
                log.innerText = "同步失败，请确认 API Key 是否有效";
            }
        } catch (e) {
            log.innerText = "连接超时，请检查您的网络环境";
        }
    }

    // --- 初始化模拟演示数据 ---
    function startSimulation() {
        let lastPrice = 73.50;
        const now = Math.floor(Date.now() / 1000);
        for (let i = 0; i < 400; i++) {
            const o = lastPrice;
            const c = o + (Math.random() - 0.495) * 0.4;
            candleData.push({ time: now - (400 - i) * 60, open: o, high: Math.max(o, c) + 0.1, low: Math.min(o, c) - 0.1, close: c });
            lastPrice = c;
        }
        candleSeries.setData(candleData);
        runQuantitativeAnalysis();
    }

    window.onload = () => {
        initChart();
        startSimulation();

        // 界面价格数据跳动感优化
        setInterval(() => {
            const last = candleData[candleData.length - 1];
            const jitter = last.close + (Math.random() - 0.5) * 0.08;
            document.getElementById('price-display').innerText = jitter.toFixed(2);

            const base = candleData[0].close;
            const pct = ((jitter - base) / base * 100).toFixed(2);
            const pctEl = document.getElementById('pct-display');
            pctEl.innerText = `${pct > 0 ? '+' : ''}${pct}%`;
            pctEl.className = `text-xs font-bold ${pct >= 0 ? 'text-green-400' : 'text-red-400'}`;

            if (!isRealData) {
                candleSeries.update({ ...last, close: jitter });
            }
        }, 2500);
    };
</script>
</body>
</html>